<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Basic Paxos" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Paxos Made Simple 论文 Notes。" /><meta property="og:description" content="Paxos Made Simple 论文 Notes。" /><link rel="canonical" href="https://darktea.github.io/posts/paxos-made-simple/" /><meta property="og:url" content="https://darktea.github.io/posts/paxos-made-simple/" /><meta property="og:site_name" content="Darktea" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-05-26T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Basic Paxos" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-20T08:24:06+08:00","datePublished":"2013-05-26T00:00:00+08:00","description":"Paxos Made Simple 论文 Notes。","headline":"Basic Paxos","mainEntityOfPage":{"@type":"WebPage","@id":"https://darktea.github.io/posts/paxos-made-simple/"},"url":"https://darktea.github.io/posts/paxos-made-simple/"}</script><title>Basic Paxos | Darktea</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Darktea"><meta name="application-name" content="Darktea"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/favicons/android-chrome-512x512.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Darktea</a></div><div class="site-subtitle font-italic">Know nothing</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/darktea" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['tiantianding','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Basic Paxos</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Basic Paxos</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/darktea">darktea</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1369497600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2013-05-26 </em> </span> <span> 更新于 <em class="timeago" data-ts="1658276646" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-07-20 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6135 字"> <em>34 分钟</em>阅读</span></div></div></div><div class="post-content"><p>Paxos Made Simple 论文 Notes。</p><h2 id="一-算法背景"><span class="mr-2">一. 算法背景</span><a href="#一-算法背景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Paxos 算法是用来解决什么问题？</p><p>先看一个场景: 一个日志收集系统，需要从多个不同的机器上收集日志。</p><p>最简单的实现方式是，找一台中心服务器，所有的日志生产机器作为客户端，不断的把日志发送到中心服务器，中心服务器存放所有收集到的日志。</p><p>但这种实现方式有一个问题，中心服务器是一个单点，一旦中心服务器发生故障，整个系统不可用。</p><p>改进方案: 找多个服务器来收集日志，例如 2 个。当每台日志生产机器需要提交日志时，每条日志都同时被提交到两台收集日志的服务器上面。</p><p>这样，同时有多个日志收集服务器在工作，解决了单点问题。</p><p>但这种多收集服务器的实现方式有另外一个问题，两台收集日志服务器上收集到的日志可能会不一致。</p><p>例如，假设有两台日志生产机器 P1，P2; 同时有两台日志收集机器: Q1，Q2。考虑下面这种情况:</p><ol><li>P1 发送一条日志信息 M1 分别到 Q1，Q2<li>P2 发送一条日志信息 M2 分别到 Q1，Q2</ol><p>但由于实际网络的状况，日志被收集到的顺序在 Q1，Q2 可能会不一致，例如:</p><ul><li>Q1 收集到的日志的顺序是 M1，M2<li>而 Q2 收集到的日志的顺序是 M2，M1</ul><p>上面的请求只是一种不一致的情况，现实环境中，情况更加复杂，可能会遇到更多的问题 (例如，由于网络不稳定，P1 发出的消息 M1 到达了 Q1，但 M1 没有到达 Q2，丢失了)</p><p>上面这种场景是一个典型的分布式系统的共识 (<strong>consensus</strong>) 问题:</p><ul><li>在一个分布式系统中，有一些 processes，每个 process 都可以提出一个 value<li>consensus 算法就是用来从这些 values 里选定一个最终 value<li>如果没有 value 被提出来，那么就没有 value 被选中<li>如果某个 value 被选中，那么所有的 processes 都应该被学习到</ul><p>有很多分布式一致性算法来解决这种问题。</p><p>而 <strong>Paxos 算法就是一种分布式一致性算法，同时 Paxos 还具有容错性，能在各种错误环境中，保证一致性</strong>。</p><h2 id="二-系统模型"><span class="mr-2">二. 系统模型</span><a href="#二-系统模型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>算法设定了三种角色:</p><ul><li>提议者（proposers）：提议者提出提案<li>决策者（acceptors）：决策者负责批准提案<li>学习者（learners）：一旦某个提案被多数派决策者批准，那么就形成了一个决议。当决议形成以后，学习者负责学习决议 (我的理解是学习者感知到这个决议已经产生了，并以某种形式把决议持久化)</ul><p>在具体实现中，某个 process 可以扮演多个角色。</p><p>这里还有一个 <strong>多数派</strong> 的概念: acceptors 数量为 n，超过 (n+1)/2 的 acceptors 的集合就是一个多数派。</p><p>节点之间通过发送消息进行通信，通信方式采用异步，非拜占庭模型，该模型中：</p><ul><li>process 以任意的速度进行操作，可能因为故障而停止，也可以重新启动。并且 processes 选举出来的决议的值不会因为重启等故障而丢失<li>消息可以延迟发送，多次发送或丢失，但不会被篡改（即不存在拜占庭问题）</ul><p>一般来说，分布式算法都需要满足 Safety 和 Liveness：</p><ul><li>Safety：一般指一致性，正确性<li>Liveness: 一般指不会死锁，活锁</ul><p>具体到 Paxos 算法的系统模型中：</p><p>Safety:</p><ul><li>最后形成的决议必须是之前被提议者提出的提案<li>算法的每次执行，最后只能形成一个决议（这个最重要，如果不满足这个，那么会形成多个决议，就出现不一致了）<li>只有形成决议以后才能被学习者学习（在形成决议之前，提案是不能被学习的）</ul><p>Liveness:</p><ul><li>只要有提案被提出，保证最终有一个提案会被选出来做为决议<li>决议形成以后，学习者最后能学习到决议</ul><h2 id="三-解决思路"><span class="mr-2">三. 解决思路</span><a href="#三-解决思路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>基于前面描述的系统模型，最简单的解决办法就是只设置一个 acceptor，而这个 acceptor 只批准它接收到的第一个提案。但这种实现中的 acceptor 是一个单点，不能处理各种故障。</p><hr /><p>改进方式，利用多个 acceptors + 多数派：</p><ul><li>设置多个 acceptors<li>每个 acceptors 最多只能批准一个提案（如果每个 acceptor 能批准多个提案，就乱了，不能形成多数派）<li>对于某个提案，只要 acceptors 中有一个多数派批准，就形成决议</ul><p>另外，为了满足 Liveness，还需要规定：</p><p>P1: 一个 acceptor 必须批准它收到的第一个提案</p><p>这样就保证了即使只有一个提案被提出，也必然能形成决议。</p><p>但这种解决方案存在问题:</p><ul><li>某个 acceptor 发生故障，就可能不会出现多数派，不能得到决议；这时，就可能需要进行多次提交提案，进行多次批准。<li>而允许多次提交，多次批准，就可能违背 Safety 中的第二条。可能形成多个不同内容的决议。</ul><hr /><p>为了解决「允许多次提交，多次批准」可能造成的形成多个不同内容的决议的问题，Paxos 在前面的实现方案的基础上，又加入了一系列的限制条件（P2，P2a，P2b，P2c）：</p><ul><li>P2 -&gt; P2a -&gt; P2b -&gt; P2c<li>只要满足 P2 就能满足 Safety 的第二条，但是 P2 比较难实现<li>然后又想出来 P2a；只要满足 P2a，P2 也就满足了；但是发现 P2a 存在问题，需要修订（P1 和 P2a 有冲突，如果要满足 P1，有的情况下，就做不到 P2a）<li>然后又想出来 P2b；P2b 和 P1 不冲突，只要 P1 和 P2b 同时满足就可以解决问题；但 P2b 比较难实现<li>然后又想出来 P2c；只要满足 P2c，P2b 也就满足了；<strong>Paxos 算法就是基于 P2c 实现的</strong></ul><p>下面一节详细介绍这些限制条件。</p><h2 id="四-p2---p2a---p2b---p2c"><span class="mr-2">四. P2 -&gt; P2a -&gt; P2b -&gt; P2c</span><a href="#四-p2---p2a---p2b---p2c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Paxos 算法中，给每个提案引入了 <strong>版本号</strong> 的概念。每个提案由两部分组成:</p><ul><li>提案内容: v<li>提案版本号：n</ul><p>这样每个提案就是一个二元组: {v, n}</p><p>同时，Paxos 规定，在全局范围内（所有的 processes 提出的提案），每个提案有唯一的版本号，这样所有的版本号就形成了一个全序关系。</p><p>而且，既然所有提案的版本号是全局范围内的全序关系，也就给所有的提案进行逻辑时间上的排序提供了可能：</p><p>例如，两个提案: V{v, n}，W{w, m}，如果 n &gt; m，可以认为<strong>提案 V 比 提案 W 后提出</strong>。</p><p>后面具体介绍算法时也会提到，怎么利用版本号来规定提案的时间顺序。</p><h3 id="1-p2"><span class="mr-2">1. P2</span><a href="#1-p2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>P2: 假设一个提案 {v, n} 已经被选为决议，对于选出来的其他所有决议 {w, m}， 如果 m &gt; n， 那么内容 w 必须和内容 v 相同</p><p>说明:</p><p>前面已经说过，利用版本号可以在逻辑上对全局时间排序，m &gt; n，代表，{w, m} 是在 {v, n} 之后的提案 (但怎么利用版本号来排序这里没有说，后面才会讲，现在姑且这样认为)。</p><p>P2 其实就是说（参考前面 Safety 的第二条），一旦已经形成了一个决议，那么之后如果又发生了多次提交，多次批准，而形成了新的决议，那么形成的新的决议必须和之前形成的决议的内容相同。</p><h3 id="2-p2a"><span class="mr-2">2. P2a</span><a href="#2-p2a" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>因为 P2 限制很难实现，就想出了 P2a。</p><p>P2a：假设一个提案 {v, n} 已经被选为决议，其他所有被 acceptors 批准的提案 {w, m}，如果 m &gt; n，那么内容 w 必须和内容 v 相同</p><p>显而易见，P2a 被满足了的话，P2 也就满足了。</p><p>但 P2a 存在一个问题：P2a 和 P1 有些时候会冲突（P1 是 Liveness 的限制），也就是说，满足了 P1 的话，有的时候，做不到满足 P2a：</p><ul><li>提案 V{v, n} 已经被选为决议<li>但在这次选举过程中，某个 acceptor 没有批准过任何提案 (也就是说，这个 acceptor 还可能批准更高版本号的提案，例如：W{w, m}，m &gt; n）<li>之后，有一个 proposer 提交了一个提案 W{w, m} 给上面这个 acceptor，而根据 P1，这个 acceptor 会批准这个提案，且这个提案的 m &gt; n，w 和 v 不相同<li>这就和 P2a 矛盾了：在 V{v, n} 已经被选为决议的情况下，任何 acceptor 批准的更高版本（&gt; n）的提案的内容必须和 v 相同</ul><p>说明: 在有一个决议已经形成的情况下，是有可能发生某个 proposer 提出新的不同内容的提案的可能的。</p><h3 id="3-p2b"><span class="mr-2">3. P2b</span><a href="#3-p2b" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>为了解决 P2a 和 P1 的冲突，想出了 P2b:</p><p>P2b: 假设一个提案 {v, n} 已经被选为决议，所有被 proposer 提出的提案 {w, m}，如果 m &gt; n，那么内容 w 必须和内容 v 相同</p><p>一个提案被 acceptor 批准之前肯定要由某个 proposer 提出，因此 P2b 就隐含了 P2a，进而隐含了 P2。</p><h3 id="4-p2c"><span class="mr-2">4. P2c</span><a href="#4-p2c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>怎么做到 P2b 呢？又想出了 P2c。</p><p>P2c：如果某个 proposer 要提出一个提案 {v, n}，那么必须满足下面两个条件中的一个：</p><ol><li>存在一个 acceptors 的多数派 S，其中的任何一个 acceptor 都没有批准过比 n 小的提案<li>存在一个 acceptors 的多数派 S，集合中的某些 acceptor 曾经批准过小于 n 的提案，而所有的这些版本号小于 n 的提案中，拥有最大的版本号那个提案的内容与 v 相同</ol><p>也就是说，如果每个 proposer 都按 P2c 为约束来提出一个提案，那么就可以满足 P2b，即：</p><ul><li>要么还没有形成决议，可以任选提案的内容<li>要么提出的版本号更高的提案的内容和已经形成的决议的内容相同</ul><p>对 P2c 的理解如下:</p><p><strong>证明1</strong>：假设现在 n=4 的 proposal 已经被选举出来了，那么我们要证明在满足上面两个条件的前提下提出一个 n=5 的提案，那么这个 n=5 的提案的内容肯定和 n=4 的提案的内容一致</p><ul><li>第一个条件：能找到一个多数派集合，其中所有的人都没有批准过比 5 小的提案（这种情况是不可能发生的，因为 n=4 的提案已经被通过了）<li>第二个条件：能找到一个多数派集合，首先来看，如果其中某人批准过 n=4 的提案，只要这个n=4 的提案的内容和 n=5 的提案的内容相等的话（4 是比 5 小的数中最大的一个），那么如果 n=5 的提案被选举出来，就是 ok 的（不会破坏上一次选举 n=4 的结果）；其次，会不会其中没有人批准过 n=4，只发现有人批准过 n&lt;=3 的提案？不可能，因为 n=4 的提案已经被多数派批准选举出来了</ul><p><strong>证明2</strong>：假设现在 n=4 的 proposal 已经被选举出来了，那么我们要证明在满足上面两个条件的前提下提出一个 n=6 的提案，那么这个 n=6 的提案的内容肯定和 n=4 的提案的内容一致</p><ul><li>第一个条件：能找到一个多数派集合，其中所有的人都没有批准过比 6 小的提案（这种情况是不可能发生的，因为 n=4 的提案已经被通过了）<li>第二个条件：能找到一个多数派集合，首先来看，如果其中某人批准过 n=5 的提案，而这个 n=5 的提案的内容肯定和 n=4 的提案的内容相同（证明 1 证明）。所以只要这个 n=5 的提案的内容和 n=6 的提案的内容相等的话，n=6 的提案的内容也就和 n=4 的提案的内容相同</ul><p>总之，只要 proposer 提交提案时遵守 P2c，一旦某个版本号的决议形成，之后形成的更高版本的决议的内容也和最早形成的决议的内容相同。</p><p>这里可能有人会提出疑问，前面说了这么多，都说的是，决议从小到大形成的情况，会不会有先形成大版本号的决议，再形成小版本号的决议的情况？比如下面这种场景：</p><ol><li>先形成了 4 号决议<li>接下来，有一个 proposer 企图提出版本号为 3 的提案。此时这个 proposer 是否能够找到一个多数派，其中所有的人都没有批准过比 3 小的提案？（多数派里面的所有成员都批准了 4 号提案）</ol><p>答案是考虑 P2 系列的约束时，不用考虑版本号会降低的情况，因为下面一个小节引入的 P1a。一旦 4 号决议形成，n &lt; 4 的提案就不可能被提出。</p><p>也就是说，多个决议形成，只能是从小的版本号升到大的版本号。</p><h3 id="5-提案生成算法"><span class="mr-2">5. 提案生成算法</span><a href="#5-提案生成算法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>保证 P2c，也就是要保证 proposer 在提出一个提案时，必须满足 P2c。所以 proposer 想要提交提案时需要 2 个步骤：</p><ol><li>先探查一下是否能找到 P2c 中描述的多数派<li>如果找到了多数派，就可以提交提案了（根据找到的多数派的不同类型，或者提出任意内容的提案，或者提出和之前形成的低版本的决议内容一致的提案）</ol><p>这里有个问题要特别注意一下:</p><p>因为这两个步骤之间有时间间隔，可能在第一步找到了一个多数派，但到了第二步要提交提案的时候，第一步找到的那个多数派中的某个 acceptor 的状态已经变化了。</p><p>此时如果再提交提案，那个多数派可能已经不满足 P2c 了。</p><p>所以，在第一步探查多数派的同时，也要锁死被探查的 acceptor 的状态。</p><p>具体怎么做，看下面的提案生成算法的描述：</p><p>proposer 选择一个版本号 n，然后向一个 acceptors 的集合发送请求，要求 acceptor 做出以下动作：</p><ol><li>承诺不再批准任何小于 n 的提案（锁定 acceptor 的状态不破坏 P2c）<li>返回这个 acceptor 到目前为止已经批准过的，且小于 n 的最大版本号的提案。返回消息为：内容+版本号（如果没有批准过任何版本号小于 n 提案，返回一个空值）</ol><p>如果 proposer 收到了一个多数派的返回响应，那么这个 proposer 可以提出版本号为 n 的提案，其对应的内容为：</p><ol><li>如果返回的所有响应都是一个空值（也就是说，存在一个多数派没有批准过小于 n 的提案），提出的提案的内容可以任选<li>找出所有响应中最大版本号的内容，作为要提交的提案的内容</ol><p>总之，proposer 生成提案需要两个步骤，发送两种请求：</p><ol><li><strong>prepare</strong> 请求: 询问状态; 希望 acceptor 端做出承诺，并返回响应<li><strong>accept</strong> 请求：提交提案；希望 acceptor 端批准提案</ol><p>前面说的是 proposer 端的算法。接下来说一下 acceptor 端的算法：</p><ul><li>acceptor 收到 proposer 的两种请求都可以不做任何回答（因为不回答不会破坏算法的安全性）<li>如果要对 prepare 请求做出响应，只要做出承诺，并根据其当前的状态返回响应就行了（找出目前为止已经批准过的，且版本号小于 n 的最大版本号的提案，作为响应返回）<li>而对于 accept 请求，必须查看是否之前已经做过承诺，只有在不违反承诺的情况下才能返回响应</ul><p>这就是 P1a：一个 acceptor 只有在没有响应过任何版本号大于 n 的 prepare 请求时，才会批准一个编号为 n 的提案。</p><p>换句话说，acceptor 如果承诺过不会批准任何小于 n 的提案，那么它会拒绝之后收到的任何小于 n 的 accept 请求。</p><p>而 P1a 和 P1 不矛盾。所以只要同时满足 P1a 和 P2c 就可以达到 Safety。</p><p>P1a 的存在也规定了在 Paxos 算法中，多个决议形成，只能是从小的版本号升到大的版本号（例如：一旦 3 号决议形成，之后再形成新的决议，新的决议的版本号 &gt; 3）</p><h2 id="五-paxos-算法"><span class="mr-2">五. Paxos 算法</span><a href="#五-paxos-算法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>上一节已经说过了，同时满足 P1a 和 P2c 就可以达到 Safety 满足一致性。不过在这个基础上还可以做一个优化：</p><ul><li>如果某个 acceptor 先对版本号为 5 的 prepare 请求返回过承诺，那么当它之后收到一个版本号为 4 的 prepare 请求时，这个 acceptor 可以忽略这个版本号为 4 的 prepare 请求<li>因为，就算对 4 号 prepare 请求返回响应，之后也不会批准 4 号提案的 accept 请求</ul><p>acceptor 需要持久化两种信息：</p><ul><li>它已经批准过的最大版本号的提案<li>它已经承诺过的 prepare 请求中的最大版本号的请求的版本号</ul><p>这里要特别解释一下为什么只需要保存「已经批准过的最大版本号的提案」就行了？</p><p>前面说了，acceptor 收到一个版本号为 n 的 prepare 请求时，必须找出目前为止已经批准过的，且版本号小于 n 的最大版本号的提案，作为响应返回。</p><p>又由于上面的这个优化，当收到一个版本号为 n 的 prepare 请求时：</p><ul><li>如果发现目前已经批准过的所有提案的最高版本号为 m，且 n &lt;= m，那么可以不响应这个 prepare 请求（因为采用前面的优化，一旦做过版本号为 m 的承诺，就可以不给所有小于等于 m 的 prepare 请求返回响应）<li>如果发现目前已经批准过的所有提案的最高版本号为 m，且 n &gt; m，那么就返回这个版本号为 m 的提案就行了</ul><p>总之，当 acceptor 重启恢复以后，只要能重新拿到这两个信息，就可以恢复到正常工作状态。同时，proposer 不需要持久化任何信息，可以随意重启（只需要每次提交提案时，都用一个全局唯一的版本号就行了）</p><p>【完整的算法如下】:</p><ul><li>3 种身份：proposer，acceptor，learner<li>2 个阶段：【准备阶段】 &amp;【 批准阶段】<li>准备阶段：<ul><li>proposer 群发一个 prepare 请求（版本号为 n） 给一个 acceptor 的多数派<li>每个 acceptor 会存储曾经在【批准阶段】批准过提案中，最大版本号的提案（w+m），w 为提案内容，m 为提案版本<li>每当 acceptor 接收到一个 prepare 请求（版本号为 n）：<ul><li>如果 n &gt; m，那么把（w+m）返回给 proposer<li>如果之前没有批准过任何提案，返回「空」给 proposer<li>如果 n &lt;= m，那么 proposer 不对这个 prepare 请求（版本号为 n）做响应<li>承诺今后不会批准「版本号」比 n 还小（也就是 &gt;= n 的提案才会被批准）的任何提案</ul></ul><li>准备阶段解析：<ul><li>准备阶段的目的是保障 proposer 在「批准阶段」提交「版本号」为 n 的提案时，要么还没有形成决议，要么提交的版本号为 n 的提案和已形成决议的提案的内容相同<li>也就是要在准备阶段探察出一个 acceptor 的多数派：<ul><li>要么都没有批准过比 n 小的提案<li>要么把这个多数派中批准过的「版本号」比 n 小的提案中，拥有最大版本号的提案的内容，作为版本号为 n 的提案</ul><li>所以 acceptor 在收到一个「版本号」为 n 的 prepare 请求时，需要找出批准过的，比 n 小的最大版本号的提案的（内容+版本号）返回给 proposer<li>按道理，acceptor 需要存储所有曾经批准过的（提案内容+提案版本）；但可以做一个优化：只存储曾经批准过的最大版本号的 提案内容 + 提案版本（w+m）<ul><li>因为当接收到的 prepare 请求的「版本号」n&lt;=m 时，那么 acceptor 不应该对这个版本号为 n 的 prepare 请求做应答（这时因为，即便是做了应答，但由于在批准阶段，曾经承诺过不会批准比 m 小的提案，版本号为 n 的提案会被拒绝掉）</ul><li>每个 acceptor 需要存储承诺过的「最大版本号」（假设为 maxVersion）</ul><li>批准阶段：<ul><li>proposer 从 acceptor 的多数派的获得到了 prepare 请求的响应<li>proposer 从这些响应中挑出 版本号「最大的」提案内容（假设该内容为 w）<li>proposer 群发一个「批准请求」（版本号为 n，内容为 w） 给一个 acceptor 的多数派<ul><li>如果 proposer 获得的所有响应都为空，那么群发的「提案」可以是任何内容</ul><li>每个 acceptor 接收到一个「批准请求」（版本号为 n，内容为 w）：<ul><li>如果<strong>不违反</strong>之前的承诺（n &gt;= maxVersion 的提案才会被批准），就返回「批准响应」给 proposer<li>否则，对这个「批准请求」不做回应</ul></ul></ul><h2 id="六-思考"><span class="mr-2">六. 思考</span><a href="#六-思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>在现实中，其实是更关注 Paxos「多实例」的场景，也就是不是单次 Paxos 过程，而是一序列的多个 Paxos 过程，例如：instance0, instance1, instance2…<ul><li>但值得注意的是，并不要求时间上按顺序完成这些 instances。例如，可以先完成 instance1 和 instance2，但 instance0 可能一直未完成；也就是出现了一个「实例空洞」<li>为什么可以不按顺序完成这些 instances？这时因为计算机的工作可以抽象成：数据+计算；而 Paxos 只关注数据上达成共识，而出现了 instance 空洞，是否能完成计算，可由计算的具体策略来决定，Paxos 无需关注</ul></ul><h2 id="参考文档"><span class="mr-2">参考文档</span><a href="#参考文档" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><a href="https://github.com/dsdoc/dsdoc/blob/master/paxosmadesimple/index.rst">https://github.com/dsdoc/dsdoc/blob/master/paxosmadesimple/index.rst</a><li><a href="http://hi.baidu.com/tkdsheep/item/bebe140729acd60b6c9048f7">http://hi.baidu.com/tkdsheep/item/bebe140729acd60b6c9048f7</a><li><a href="http://blog.csdn.net/sparkliang/article/details/5740882">http://blog.csdn.net/sparkliang/article/details/5740882</a><li><a href="http://blog.csdn.net/colorant/article/details/8431934">http://blog.csdn.net/colorant/article/details/8431934</a><li><a href="http://www.vpsee.com/2009/09/paxos-algorithm/">http://www.vpsee.com/2009/09/paxos-algorithm/</a><li><a href="http://stblog.baidu-tech.com/?p=1196">http://stblog.baidu-tech.com/?p=1196</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E5%88%86%E5%B8%83%E5%BC%8F/'>分布式</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/paxos/" class="post-tag no-text-decoration" >paxos</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Basic Paxos - Darktea&amp;url=https://darktea.github.io/posts/paxos-made-simple/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Basic Paxos - Darktea&amp;u=https://darktea.github.io/posts/paxos-made-simple/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://darktea.github.io/posts/paxos-made-simple/&amp;text=Basic Paxos - Darktea" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/rust-notes/">Rust Notes</a><li><a href="/posts/build-system/">Build Systems</a><li><a href="/posts/On-Designing-and-Deploying-Internet-Scale-Services/">On Designing and Deploying Internet-Scale Services</a><li><a href="/posts/URL-Encoding/">URL Encoding</a><li><a href="/posts/memory-manager/">Linux 内存管理</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/notes/">notes</a> <a class="post-tag" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a> <a class="post-tag" href="/tags/2pc/">2pc</a> <a class="post-tag" href="/tags/autotools/">autotools</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/bazel/">bazel</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/c/">c</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/2PC/"><div class="card-body"> <em class="timeago small" data-ts="1396800000" > 2014-04-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>经典 TWO-PHASE COMMIT PROTOCOL</h3><div class="text-muted small"><p> 本文详细描述经典的 TWO-PHASE COMMIT PROTOCOL（后面简称 2PC 协议）。 注意：本文只描述了经典的 2PC。没有描述 2PC 的各种变种和优化。 为了更好的理解，先描述一下无故障时协议怎么工作。 然后再对协议运行过程中可能碰到的各种故障进行讨论，说明在这些故障的场景下，怎么处理这些故障来保证协议的正确性。 一 经典 2PC 协议无故障时的工作流程...</p></div></div></a></div><div class="card"> <a href="/posts/right/"><div class="card-body"> <em class="timeago small" data-ts="1679587200" > 2023-03-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>右值引用</h3><div class="text-muted small"><p> 按 C++ 标准的发展来梳理出右值引用的概念。但会先复习一下引用的概念。 引用 先复习一下 C++ 中引用的概念： A reference defines an alternative name for an object 引用就是另外一个已经存在的对象的名字的别名 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ...</p></div></div></a></div><div class="card"> <a href="/posts/chatbot/"><div class="card-body"> <em class="timeago small" data-ts="1670342400" > 2022-12-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>chatbot</h3><div class="text-muted small"><p> 对话型应用 对话型应用也既是 chatbot 的中文翻译。 首先，对话型应用是智能应用，是当今最热门的「机器学习」（AI） 技术的典型应用。 所以，chatbot（对话型应用）是「智能应用」。何谓「智能应用」？如下图所示，通过在训练阶段获得的模型来处理真实的数据： flowchart LR A[[Training data]] --&amp;gt;B(ML argorithm) --&amp;gt...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Redis-PSYNC/" class="btn btn-outline-primary" prompt="上一篇"><p>Redis PSYNC</p></a> <a href="/posts/memory-manager/" class="btn btn-outline-primary" prompt="下一篇"><p>Linux 内存管理</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/darktea">darktea</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/notes/">notes</a> <a class="post-tag" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a> <a class="post-tag" href="/tags/2pc/">2pc</a> <a class="post-tag" href="/tags/autotools/">autotools</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/bazel/">bazel</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/c/">c</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
